<!doctype html>
<head>
  <title>TicTacToe</title>
  <link rel="stylesheet" href="index.css" type="text/css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  </script>
  <script type="text/javascript">
  $(document).ready(function() {
 //  	var socket = io.connect();
 //  	var players = [];
 //  	socket.on("moveFocusAndClick", function (data) {
 //  		moveFocusAndClick(data);
 //  	})

 //  	socket.on("playersReceived", function (data) {
	// 	console.log(data);
	// 	players.push(data.name);
	// })

  })
  </script>
  </head>
  <body>
	  <div onkeyup="moveFocusAndClick(event)" tabindex="0" id="board">
		  <input  type="checkbox" id="a11" /><label for="a11">Top left</label>
		  <input  type="checkbox" id="a12" /><label for="a12">Top center</label>
		  <input  type="checkbox" id="a13" /><label for="a13">Top right</label>
		  
		  <input type="checkbox" id="a21" /><label for="a21">Middle left</label>
		  <input type="checkbox" id="a22" /><label for="a22">Middle center</label>
		  <input type="checkbox" id="a23" /><label for="a23">Middle right</label>

		  <input type="checkbox" id="a31" /><label for="a31">Bottom left</label>
		  <input type="checkbox" id="a32" /><label for="a32">Bottom center</label>
		  <input type="checkbox" id="a33" /><label for="a33">Bottom right</label>
	  </div>

	  <p id="plist"></p>
	  <p id="info"></p>	

	  <div id="chat"></div>

  <script type="text/javascript">

	var socket = io.connect();
  	var players = [];
  	socket.on("moveFocusAndClick", function (data) {
  		moveFocusAndClick(data);
  	})

  	socket.on("chatMsg", function (data) {
  		$('#chat').append('<p>'+data.message+'</p>')
  		document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
  	})

  	socket.on("playersReceived", function (data) {
		console.log(data);
		players.push(data.name);
		currentPlayer = players[0]
		document.getElementById('plist').innerHTML = currentPlayer + "'s turn" ;
	})

  var checkboxes = document.getElementsByTagName('input');
  var squares = ["a11", "a12", "a13", "a21", "a22", "a23", "a31", "a32", "a33"];
  
  var board = document.getElementById('board');
  var square  = document.getElementById(squares[0]);
  var index = 0 ;
  var currentPlayer;// = players[0];
  // console.log(players)
  // var players = ['X', 'O'];

  function getNextPlayer(){
	  if (currentPlayer === players[0]){
		  currentPlayer = players[1];
	  }else{
		  currentPlayer = players[0];
	  }
	  document.getElementById('plist').innerHTML = currentPlayer + "'s turn" ;
	  console.log(currentPlayer);
  }
  
square.focus();




function resetGame() {
	  // console.log(currentPlayer);
	for(var i=0; i<checkboxes.length; i++) {
    	checkboxes[i].indeterminate = true;
    	checkboxes[i].checked = undefined;
  	}	
  	// var board = document.getElementById('board');
  	document.getElementById('info').innerHTML = "";
  	square.focus();
}

resetGame();
  
  function moveFocusAndClick(event){
	  console.log(event.playerName);



	  if (players.length < 2) {
	  	console.log("not enough players");
	  	return
	  }

	  if (currentPlayer !== event.playerName) {
	  	return
	  }

	  if (event.keyCode === 40){
		  getCellBelow();
	  }else if (event.keyCode === 38){
		  getCellAbove();
	  }else if(event.keyCode === 37){
		  getLeftCell();
	  }else if(event.keyCode === 39){
		  getRightCell();
	  }else if(event.keyCode === 13){
		  if(!(square.indeterminate)) {
			  return;
		  }
		  if(currentPlayer === players[1]){
		  	console.log("im p1");
			  square.click();
			  // square.click();
			  square.checked = false;
		  }else{
			  square.click();
			  square.checked = true;
		  }
		  if (currentPlayer === players[0]) {
			  checkStatus();
		  } else {
			  checkStatusUnchecked();
		  }
		  
		  getNextPlayer();
		  return
	  }else{
		//do nothing 
	  }
	  square.focus();

  }

  function checkTie() {
  	console.log("tiecheck");
  	for(var i=0; i<checkboxes.length; i++) {
    	if (checkboxes[i].indeterminate) {
    		return 
    	}    	
  	}	
  	document.getElementById('info').innerHTML = "It's a tie!";
  	setTimeout(resetGame, 3000);
  }

  function winMessage() {
		console.log("Player " + currentPlayer + " wins");		
		// document.getElementById('plist').innerHTML = "Player" + currentPlayer + "wins";
		// setTimeout(location.reload(true), 3000);
		console.log("resetting");
		document.getElementById('info').innerHTML = "Player " + currentPlayer + " wins";
		setTimeout(resetGame, 3000);				
		return
  }

  function checkStatus(){

	  var square_a11 = document.getElementById('a11');
	  var square_a21 = document.getElementById('a21');
	  var square_a31 = document.getElementById('a31');
	  var square_a12 = document.getElementById('a12');
	  var square_a22 = document.getElementById('a22');
	  var square_a32 = document.getElementById('a32');
	  var square_a13 = document.getElementById('a13');
	  var square_a23 = document.getElementById('a23');
	  var square_a33 = document.getElementById('a33');

	  checkTie();

	  if (square_a11.checked && square_a21.checked && square_a31.checked){
	  	winMessage();
	  }

	  if (square_a11.checked && square_a12.checked && square_a13.checked){
		  winMessage();
	  }

	  if (square_a21.checked && square_a22.checked && square_a23.checked){
		  winMessage();
	  }

	  if (square_a31.checked && square_a32.checked && square_a33.checked){
		  winMessage();
	  }

	  if (square_a12.checked && square_a32.checked && square_a22.checked){
		  winMessage();
	  }

	  if (square_a13.checked && square_a23.checked && square_a33.checked){
		  winMessage();
	  }

	  if (square_a11.checked && square_a22.checked && square_a33.checked){
		  winMessage();
	  }

	  if (square_a13.checked && square_a22.checked && square_a31.checked){
		  winMessage();
	  }
	  
	  
  }
  
  function checkStatusUnchecked(){
	  var square_a11 = document.getElementById('a11');
	  var square_a21 = document.getElementById('a21');
	  var square_a31 = document.getElementById('a31');
	  var square_a12 = document.getElementById('a12');
	  var square_a22 = document.getElementById('a22');
	  var square_a32 = document.getElementById('a32');
	  var square_a13 = document.getElementById('a13');
	  var square_a23 = document.getElementById('a23');
	  var square_a33 = document.getElementById('a33');

	  var a11Unchecked = !square_a11.checked && !square_a11.indeterminate;
	  var a21Unchecked = !square_a21.checked && !square_a21.indeterminate;
	  var a31Unchecked = !square_a31.checked && !square_a31.indeterminate;
	  var a12Unchecked = !square_a12.checked && !square_a12.indeterminate;
	  var a22Unchecked = !square_a22.checked && !square_a22.indeterminate;
	  var a32Unchecked = !square_a32.checked && !square_a32.indeterminate;
	  var a13Unchecked = !square_a13.checked && !square_a13.indeterminate;
	  var a23Unchecked = !square_a23.checked && !square_a23.indeterminate;
	  var a33Unchecked = !square_a33.checked && !square_a33.indeterminate;

	  checkTie();
	  
	  if (a11Unchecked &&  a21Unchecked && a31Unchecked){
		  winMessage();
	  }

	  if (a12Unchecked &&  a22Unchecked && a32Unchecked){
		  winMessage();
	  }

	  if (a13Unchecked && a23Unchecked && a33Unchecked){
		   winMessage();
	  }

	  if (a11Unchecked &&  a12Unchecked && a13Unchecked){
		  winMessage();
	  }

	  if (a21Unchecked &&  a22Unchecked && a23Unchecked){
		  winMessage();
	  }

	  if (a31Unchecked &&  a32Unchecked && a33Unchecked){
		  winMessage();
	  }

	  if (a11Unchecked && a22Unchecked && a33Unchecked){
		  winMessage();
	  }

	  if (a13Unchecked && a22Unchecked && a31Unchecked){
		  winMessage();
	  }


  }

  function getLeftCell(){
	  if (index === 0 || index === 3 || index === 6){
		  return
	  }
	  square = document.getElementById(squares[--index]);
  }

  function getRightCell(){
	  if( index === 2 || index === 5 || index === 8){
		  return
	  }
	  square = document.getElementById(squares[++index]);
  }

  function getCellAbove(){
	  if(index < 3){
		  return
	  }
	  index = index - 3;
	  square = document.getElementById(squares[index]);
  }

  function getCellBelow(){
	  if( index > 5){
		  return
	  }
	  index = index + 3;
	  square = document.getElementById(squares[index]);
  }

  function getNextCell(){
	  square = document.getElementById(squares[++index]);
  }
  </script>

</body>
